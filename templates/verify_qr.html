{% extends "base.html" %}
{% block content %}

<style>
.verify-wrap {
    max-width: 720px;
    margin: 2.5rem auto;
    animation: fadeUp .65s ease both;
}

/* ── Main card ── */
.verify-card {
    background: var(--surface);
    border: 1px solid var(--rim2);
    border-radius: var(--r-lg);
    overflow: hidden;
    position: relative;
    box-shadow: 0 24px 60px rgba(0,0,0,.5);
    margin-bottom: 1.5rem;
}
.verify-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--violet), var(--rose), var(--amber), var(--mint));
}
.verify-card::after {
    content: '';
    position: absolute; top: -60px; right: -60px;
    width: 200px; height: 200px; border-radius: 50%;
    background: radial-gradient(circle, rgba(124,92,252,.13) 0%, transparent 70%);
    pointer-events: none;
}
.verify-card-body { padding: 2rem; }
@media (max-width: 576px) { .verify-card-body { padding: 1.4rem; } }

/* ── Header ── */
.verify-header {
    display: flex; justify-content: space-between;
    align-items: flex-start; flex-wrap: wrap; gap: .8rem;
    margin-bottom: 1.8rem;
}
.verify-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.2rem; letter-spacing: .06em;
    color: var(--text); line-height: 1; margin-bottom: .25rem;
}
.verify-subtitle {
    font-family: 'DM Sans', sans-serif;
    font-size: .83rem; color: var(--muted); font-weight: 300;
}
.staff-badge {
    display: inline-flex; align-items: center; gap: .45rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: .62rem; letter-spacing: .14em; text-transform: uppercase;
    background: rgba(255,179,71,.1); color: var(--amber);
    border: 1px solid rgba(255,179,71,.25);
    padding: .35rem .9rem; border-radius: 100px;
    white-space: nowrap;
}
.staff-badge-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--amber); box-shadow: 0 0 8px var(--amber);
    animation: glowAmber 1.6s ease infinite;
}
@keyframes glowAmber {
    0%,100% { box-shadow: 0 0 6px var(--amber); }
    50%      { box-shadow: 0 0 18px var(--amber); }
}

/* ── Scanner panel ── */
.scanner-panel {
    background: var(--surface2);
    border: 1px solid var(--rim2);
    border-radius: var(--r);
    padding: 1.4rem;
    margin-bottom: 1.5rem;
}
.scanner-actions { display: flex; flex-wrap: wrap; gap: .65rem; margin-bottom: .9rem; }

.btn-start {
    font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: .875rem;
    background: linear-gradient(135deg, var(--violet), var(--rose));
    color: #fff; border: none;
    padding: .6rem 1.3rem; border-radius: var(--r);
    cursor: pointer; transition: all .22s ease;
    display: inline-flex; align-items: center; gap: .5rem;
    box-shadow: 0 0 18px rgba(124,92,252,.3);
}
.btn-start:hover { transform: translateY(-2px); box-shadow: 0 4px 32px rgba(124,92,252,.5); }

.btn-stop {
    font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: .875rem;
    background: var(--surface); color: var(--text2);
    border: 1px solid var(--rim2);
    padding: .6rem 1.3rem; border-radius: var(--r);
    cursor: pointer; transition: all .22s ease;
    display: inline-flex; align-items: center; gap: .5rem;
}
.btn-stop:hover { border-color: var(--rose); color: var(--rose); }

.scanner-hint {
    font-family: 'DM Sans', sans-serif;
    font-size: .8rem; color: var(--muted); font-weight: 300;
    margin-bottom: .8rem; line-height: 1.5;
}

/* QR reader container */
#qr-reader {
    width: 100%; max-width: 400px;
    display: none;
    border-radius: var(--r);
    overflow: hidden;
    border: 1px solid var(--rim2);
    background: var(--bg);
}
/* Override html5-qrcode internal styles */
#qr-reader * { font-family: 'DM Sans', sans-serif !important; color: var(--text2) !important; }
#qr-reader video { border-radius: var(--r); }
#qr-reader__scan_region { background: var(--bg) !important; }
#qr-reader__dashboard { background: var(--surface2) !important; border-top: 1px solid var(--rim) !important; padding: .6rem !important; }
#qr-reader__dashboard button {
    background: var(--surface) !important; color: var(--text2) !important;
    border: 1px solid var(--rim2) !important; border-radius: 8px !important;
    font-family: 'DM Sans', sans-serif !important; font-size: .8rem !important;
}
#qr-reader__status_span { color: var(--muted) !important; font-size: .75rem !important; }

/* ── Form ── */
.verify-form-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: .65rem; letter-spacing: .12em; text-transform: uppercase;
    color: var(--muted); display: block; margin-bottom: .6rem;
}
.input-row {
    display: flex; gap: .6rem;
}
.verify-input {
    flex: 1;
    background: var(--surface2); border: 1px solid var(--rim2);
    border-radius: var(--r); color: var(--text);
    padding: .72rem 1rem;
    font-family: 'DM Sans', sans-serif; font-size: .9rem;
    outline: none; transition: border .2s, box-shadow .2s;
}
.verify-input:focus {
    border-color: var(--violet);
    box-shadow: 0 0 0 3px rgba(124,92,252,.15);
}
.verify-input::placeholder { color: var(--muted); }

.btn-verify {
    font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: .875rem;
    background: linear-gradient(135deg, var(--violet), var(--rose));
    color: #fff; border: none;
    padding: .72rem 1.4rem; border-radius: var(--r);
    cursor: pointer; transition: all .22s ease;
    box-shadow: 0 0 18px rgba(124,92,252,.3);
    white-space: nowrap;
}
.btn-verify:hover { transform: translateY(-1px); box-shadow: 0 4px 28px rgba(124,92,252,.5); }

/* ── Error ── */
.verify-error {
    margin-top: 1.2rem;
    background: rgba(255,78,142,.08);
    border: 1px solid rgba(255,78,142,.22);
    border-radius: var(--r);
    padding: .85rem 1.1rem;
    font-family: 'DM Sans', sans-serif;
    font-size: .85rem; color: var(--rose);
}

/* ── Result cards ── */
.result-card {
    border-radius: var(--r-lg);
    overflow: hidden; position: relative;
    box-shadow: 0 16px 50px rgba(0,0,0,.45);
    animation: fadeUp .5s ease both .1s;
}
.result-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
}
.result-card.success { background: var(--surface); border: 1px solid rgba(61,255,168,.25); }
.result-card.success::before { background: linear-gradient(90deg, var(--mint), var(--sky)); }
.result-card.warning { background: var(--surface); border: 1px solid rgba(255,179,71,.25); }
.result-card.warning::before { background: linear-gradient(90deg, var(--amber), var(--rose)); }

.result-card-body { padding: 1.8rem 2rem; }
@media (max-width:576px) { .result-card-body { padding: 1.4rem; } }

.result-status {
    display: flex; align-items: center; gap: .8rem; margin-bottom: .5rem;
}
.result-icon { font-size: 1.5rem; line-height: 1; }
.result-heading {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem; letter-spacing: .05em; line-height: 1;
}
.result-heading.success { color: var(--mint); }
.result-heading.warning { color: var(--amber); }

.result-desc {
    font-family: 'DM Sans', sans-serif;
    font-size: .85rem; color: var(--muted); font-weight: 300;
    margin-bottom: 1.3rem;
}

.result-divider { border: none; border-top: 1px solid var(--rim); margin: 1.2rem 0; }

.result-rows { display: flex; flex-direction: column; gap: .7rem; }
.result-row { display: flex; gap: 1.2rem; align-items: flex-start; }
.result-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: .6rem; letter-spacing: .1em; text-transform: uppercase;
    color: var(--muted); white-space: nowrap; padding-top: .15rem; flex-shrink: 0; min-width: 90px;
}
.result-val {
    font-family: 'DM Sans', sans-serif;
    font-size: .875rem; color: var(--text2); font-weight: 400;
}

@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
}
</style>

<div class="verify-wrap">

    <!-- ── Main verification card ── -->
    <div class="verify-card">
        <div class="verify-card-body">

            <div class="verify-header">
                <div>
                    <div class="verify-title">QR Verification</div>
                    <div class="verify-subtitle">Staff / Admin entry validation portal</div>
                </div>
                <span class="staff-badge">
                    <div class="staff-badge-dot"></div>
                    Staff Access
                </span>
            </div>

            <!-- Scanner controls -->
            <div class="scanner-panel">
                <div class="scanner-actions">
                    <button type="button" class="btn-start" id="startScannerBtn">
                        ◉ &nbsp;Start Camera Scanner
                    </button>
                    <button type="button" class="btn-stop" id="stopScannerBtn">
                        ✕ &nbsp;Stop Scanner
                    </button>
                </div>
                <p class="scanner-hint">Use camera to scan QR. The scanned registration ID will auto-fill below.</p>
                <div id="qr-reader"></div>
            </div>

            <!-- Manual input form -->
            <form method="post" id="verifyForm">
                {% csrf_token %}
                <label class="verify-form-label" for="registration_id">Registration ID (UUID)</label>
                <div class="input-row">
                    <input type="text" id="registration_id" name="registration_id"
                           class="verify-input"
                           placeholder="Scan QR or paste registration UUID manually">
                    <button class="btn-verify" type="submit">Verify →</button>
                </div>
            </form>

            {% if error %}
                <div class="verify-error">{{ error }}</div>
            {% endif %}

        </div>
    </div>

    <!-- ── Result ── -->
    {% if result %}
        {% if result.status == 'verified_success' %}
            <div class="result-card success">
                <div class="result-card-body">
                    <div class="result-status">
                        <span class="result-icon">✅</span>
                        <span class="result-heading success">Verification Successful</span>
                    </div>
                    <p class="result-desc">Entry is valid and attendance has been marked.</p>
                    <hr class="result-divider">
                    <div class="result-rows">
                        <div class="result-row">
                            <span class="result-label">Event</span>
                            <span class="result-val">{{ result.registration.event.title }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Attendee</span>
                            <span class="result-val">{{ result.registration.user.username }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Date</span>
                            <span class="result-val">{{ result.registration.event.date }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Venue</span>
                            <span class="result-val">{{ result.registration.event.venue }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Verified By</span>
                            <span class="result-val">{{ result.registration.verified_by.username }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Verified At</span>
                            <span class="result-val">{{ result.registration.verified_at }}</span>
                        </div>
                    </div>
                </div>
            </div>

        {% elif result.status == 'already_verified' %}
            <div class="result-card warning">
                <div class="result-card-body">
                    <div class="result-status">
                        <span class="result-icon">⚠️</span>
                        <span class="result-heading warning">Already Verified</span>
                    </div>
                    <p class="result-desc">This QR has already been used for entry.</p>
                    <hr class="result-divider">
                    <div class="result-rows">
                        <div class="result-row">
                            <span class="result-label">Event</span>
                            <span class="result-val">{{ result.registration.event.title }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Attendee</span>
                            <span class="result-val">{{ result.registration.user.username }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Verified By</span>
                            <span class="result-val">{{ result.registration.verified_by.username }}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Verified At</span>
                            <span class="result-val">{{ result.registration.verified_at }}</span>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

</div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    let html5QrCode = null;
    let scannerRunning = false;

    const qrReaderEl = document.getElementById("qr-reader");
    const registrationInput = document.getElementById("registration_id");
    const startBtn = document.getElementById("startScannerBtn");
    const stopBtn = document.getElementById("stopScannerBtn");
    const verifyForm = document.getElementById("verifyForm");

    function extractRegistrationId(scannedText) {
        const uuidRegex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/;
        const match = scannedText.match(uuidRegex);
        return match ? match[0] : scannedText.trim();
    }

    async function startScanner() {
        if (scannerRunning) return;
        qrReaderEl.style.display = "block";
        html5QrCode = new Html5Qrcode("qr-reader");
        try {
            await html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 220 },
                (decodedText) => {
                    const regId = extractRegistrationId(decodedText);
                    registrationInput.value = regId;
                    stopScanner();
                    setTimeout(() => verifyForm.submit(), 300);
                },
                () => {}
            );
            scannerRunning = true;
        } catch (err) {
            alert("Camera access failed. You can still paste the Registration ID manually.");
            console.error(err);
        }
    }

    async function stopScanner() {
        if (!html5QrCode || !scannerRunning) {
            qrReaderEl.style.display = "none";
            return;
        }
        try {
            await html5QrCode.stop();
            await html5QrCode.clear();
        } catch (err) {
            console.error(err);
        } finally {
            scannerRunning = false;
            qrReaderEl.style.display = "none";
        }
    }

    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    window.addEventListener("beforeunload", () => { if (scannerRunning) stopScanner(); });
</script>

{% endblock %}